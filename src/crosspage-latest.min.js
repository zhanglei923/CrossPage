/* 
 * CrossPage 0.5
 * https://github.com/zhanglei923/CrossPage/
 * Date: 2013-10-01 
 * 
 * Copyright (c) 2013 ZhangLei
 * 
 * Author: ZhangLei
 * Homepage: https://github.com/zhanglei923 
 * Email: zhang.lei.923@gmail.com 
 * 
 * Under the term of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
*/!function($){function checkSel(a){if(isTop()&&a.page&&"top"!=a.page&&"//"!=a.page)throw'error: reached top but still can not find: "'+a.page+'"'}function getNextSel(a){var b=trim(a.page),c=trim(a.iframe);if("self"==b&&(b=a.page=null),b){if("top"==b)return isTop()&&(a.page=null),a;if("parent"==b||"../"==b)return a.page=null,a;if(b.indexOf("../")>=0){for(var d=b.split("../"),e="",f=0,g=d.length-2;g>f;f++)e+="../";return a.page=e,a}}else if(c){var d=c.split(ARROW);if(0==d.length)return;for(var f=1,g=d.length-2;g>f;f++)e+="../";return a}}function handleRun(a,b){if(checkSel(a),!a.page&&!a.iframe)return runFn(a,b);if(a.page){var c=getNextSel(a),d=parent,e=d.jQuery,f=e[NAMESPACE],g=f.handleRun,h=g(c,b),i=h;return g=e=f=d=h=null,delete f,delete g,delete e,delete d,delete h,i}var c=a,j=a.iframe,k=parseIframeQuery(j),l=getIframe(k.id);if(l){c.iframe=k.next;var m=l.contentWindow,e=m.jQuery,f=e[NAMESPACE],g=f.handleRun,h=g(c,b),i=h;return l=g=e=f=m=h=null,delete l,delete g,delete f,delete e,delete m,delete h,i}throw"can not find iframe at:"+(a.page?a.page:"")+", "+(a.iframe?a.iframe:"")}function parseIframeQuery(a){var b,c,d=a.split(ARROW);return d.length>=2?(b=trim(d[0]),c=a.substring(a.indexOf(ARROW)+2,a.length),c=trim(c)):(b=a,c=null),{id:b,next:c}}function trim(a){return a?a.replace(/(^\s*)|(\s*$)/g,""):a}function ltrim(a){return a?a.replace(/(^\s*)/g,""):a}function rtrim(a){return a?a.replace(/(\s*$)/g,""):a}function getIframe(a){return a=getId(a),document.getElementById(a)}function getId(a){return a?(a=trim(a),a=a.indexOf("#")<0?a:a.substring(1,a.length)):void 0}function debug(a){alert($("button").html()+"\n"+a)}var NAMESPACE="crosspage",KEY=""+Math.random(),ARROW="->",me=$[NAMESPACE]={},getKey=function(){return KEY},getWinOld=function(a,b){var c=getContainerWin(a);if("undefined"==typeof b||!b)return c;if(c&&c.jQuery[NAMESPACE]){var d=c.jQuery[NAMESPACE].getChildWin(b);return d}},getContainerWin=function(a){if(a){if(a=trim(a),"./"==a||"self"==a)return window;if("//"==a||"top"==a)return top;if("parent"==a)return parent;var b=a.split("../");if(0!=b.length){for(var c=window,d=b.length-1;d>0;)if(isTop(c)){if(d>=1)return}else c=c.parent,d--;return c}}},getChildWin=function(a){var b="->",c=a.split(b);if(0!=c.length){var d=c[0];d=trim(d);var e=$(window.document.body).find(d).get(0);if(e){if(c.length>1){var f=a.indexOf(b),g=a.substring(f+b.length);g=trim(g);var h=e.contentWindow;return h.jQuery[NAMESPACE].getChildWin(g)}return e?e.contentWindow:null}}},getWin=function(a){if(!a)return null;if("undefined"==typeof a)return window;if("string"==typeof a&&(a=trim(a)),getSelType(a)==CONT_TYPE){var b=getContainerWin(a);if(!b)throw'can not find iframe window: "'+a+'"';return b}if(getSelType(a)==CHILD_TYPE){var b=getChildWin(a);if(!b)throw'can not find iframe window: "'+a+'"';return b}if(getSelType(a)==MIX_TYPE){var c=a.page,d=a.iframe;c||(c="self");var b=getWinOld(c,d);if(!b)throw'can not find iframe window at page:"'+c+'", iframe:"'+d+'"';return b}},getFrameByKey=function(a){var b;return foreachFrame(function(c){var d=c.contentWindow.jQuery;d&&d[NAMESPACE].getKey()==a&&(b=c)}),b},foreachFrame=function(a){for(var b=document.getElementsByTagName("iframe"),c=0,d=b.length;d>c;c++)try{a(b[c])}catch(e){}},getFrameByWin=function(a){try{if(a&&a.parent&&a.parent.jQuery){var b=a.parent.jQuery[NAMESPACE].getFrameByKey(a.jQuery[NAMESPACE].getKey());return b}}catch(c){throw new Error("getFrameByWin(): cross domain")}return null},getFrame=function(a){if(!a||"undefined"==typeof a)return null;if("string"==typeof a&&(a=trim(a)),getSelType(a)==CONT_TYPE){var b=getContainerWin(a);return isTop(b)?null:getFrameByWin(b)}if(getSelType(a)==CHILD_TYPE){var b=getChildWin(a);return getFrameByWin(b)}if(getSelType(a)==MIX_TYPE){var c=a.page,d=a.iframe;c||(c="self");var b=getWinOld(c,d);return getFrameByWin(b)}},setSrc=function(a,b){var c=getFrame(a);c&&(c.src=b)},getUserArgs=function(a){if(a.length<2)throw"invalid arguments: $.crosspage.getUserArgs.argument.length < 2";var b,c,d=[],e="";if(!a[1].fnName)if(isArray(a[2])&&3==a.length)e=a[1],d=a[2];else for(e=a[1],i=2,len=a.length;len>i;i++){var f=a[i];d[d.length]=f}if(2==a.length&&a[1].fnName){var g=a[1];b=g.target,e=g.fnName,d=g.params,c=g.role}return{target:b,fname:e,uargs:d,role:c}},getStdSel=function(a){"string"==typeof a&&(a=trim(a));var b={};return getSelType(a)==CONT_TYPE?(b.page=a,b.iframe=null):getSelType(a)==CHILD_TYPE?(b.page=null,b.iframe=a):getSelType(a)==MIX_TYPE&&(b=a),b.page&&(b.page=trim(b.page)),b.iframe&&(b.iframe=trim(b.iframe)),"./"==b.page&&(b.page=null),"self"==b.page&&(b.page=null),"//"==b.page&&(b.page="top"),checkSel(a),isTop()&&(b.page=null),b},invoke=function(a){var b={},c={};a.at?b=a.at:(b.page=a.page,b.iframe=a.iframe),c.target=a.target,c.fnName=a.fnName,c.params=a.params?a.params:[],run(b,c)},run=function(a){var b=getStdSel(a),c=getUserArgs(arguments);return handleRun(b,c)},runFn=function(a,b){return b.target?runAsPlugin(a,b):runAsEval(a,b)},targetExist=function(a){return $(a).size()>0?!0:!1},runAsPlugin=function(sel,info){var fn_name=info.fname,args=info.uargs;args||(args=[]),args&&!isArray(args)&&(args=[args]);var target=info.target;!targetExist(target)&&target.indexOf("#")<0&&(target="#"+target);var role=info.role,argstr="",runstr="";if(role){for(i=0,len=args.length;len>i;i++)argstr=argstr+", args["+i+"]";runstr='$("'+target+'").'+role+'("'+fn_name+'"'+argstr+");"}else{for(i=0,len=args.length;len>i;i++)argstr=argstr+(0==i?"":",")+" args["+i+"]";runstr='$("'+target+'").'+fn_name+"("+argstr+");"}return runstr="var result = "+runstr,eval(runstr),result},runAsEval=function(sel,info){var fn_name=info.fname,args=info.uargs;try{var result;return eval("result = window."+fn_name+".apply(this, args);"),result}catch(e){try{eval(fn_name)}catch(e){var err='error when running: "'+window.location.href+'" '+fn_name+"();";throw err}}},ARROW="->",CONT_TYPE="CON",CHILD_TYPE="CHILD",MIX_TYPE="MIX",conKeys=[];conKeys.top=!0,conKeys.parent=!0,conKeys.self=!0,conKeys["//"]=!0,conKeys["./"]=!0;var getSelType=function(a){return"object"==typeof a?MIX_TYPE:conKeys[a]?CONT_TYPE:a&&a.indexOf("parent")>=0?CONT_TYPE:a&&a.indexOf("./")>=0?CONT_TYPE:a&&a.indexOf("->")>=0?CHILD_TYPE:CHILD_TYPE},ePool=[],bindEvent=function(a,b){var c=ePool[a];c||(c=[]),c[c.length]=b,ePool[a]=c},fireEvent=function(a){var b=ePool[a];if(b&&b.length>0)for(var c=0,d=b.length;d>c;c++){var e=b[c];e()}},cleanEvent=function(a){ePool[a]=[]},broadcast=function(a,b){var c,d;"undefined"!=typeof b?(c=a,d=b):(c="top",d=a),run(c,"$.crosspage.broadcastImpl",d)},broadcastImpl=function(a){fireEvent(a),foreachFrame(function(b){if(hasCross(b)){var c=b.contentWindow,d=c.jQuery,e=d[NAMESPACE],f=e.broadcastImpl;f(a),c=d=e=f=null,delete c,delete d,delete e,delete f}b=null,delete b})},isTop=function(a){return"undefined"==typeof a&&(a=window),top.location==a.location},hasCross=function(a){return a.contentWindow.jQuery&&a.contentWindow.jQuery[NAMESPACE]?!0:!1},isArray=function(a){return a?"object"!=typeof a?!1:"[object Array]"===Object.prototype.toString.call(a):!1};me.broadcast=broadcast,me.broadcastImpl=broadcastImpl,me.bind=me.bindEvent=bindEvent,me.fire=me.fireEvent=fireEvent,me.clean=me.cleanEvent=cleanEvent,me.getFrame=getFrame,me.getWin=getWin,me.getChildWin=getChildWin,me.foreachFrame=foreachFrame,me.run=run,me.invoke=invoke,me.runFn=runFn,me.handleRun=handleRun,me.getFrameByKey=getFrameByKey,me.getKey=getKey,me.setSrc=setSrc}(jQuery),function(a){var b="crossgsp",c=a[b]={};c.invoke=function(b,c){a.crosspage.run(b,"$.crossgsp.onInvoke",c)},c.onInvoke=function(b){"undefined"!=typeof b&&b&&a(b.id).data("viewInstance").context.invoke({target:b.target,methodName:b.methodName,params:b.params})}}(jQuery);